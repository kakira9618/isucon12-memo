
## alp
### 概要
アクセスログ解析ツール

### インストール方法
1. alpのインストール
```
$ wget https://github.com/tkuchiki/alp/releases/download/v1.0.10/alp_linux_amd64.zip
$ sudo apt install unzip
$ unzip alp_linux_amd64.zip
$ sudo mv alp /usr/local/bin/alp
```

`alp` コマンドが使えるようになっていればOK

2. nginx用の拡張設定ファイル（log_format.conf）を作る
```
$ sudo touch /etc/nginx/conf.d/log_format.conf
$ sudo chmod 777 /etc/nginx/conf.d/log_format.conf
```

3. log_format.conf に設定を追記
```
$ sudo vim /etc/nginx/conf.d/log_format.conf
```
```
log_format ltsv "time:$time_local"
                "\thost:$remote_addr"
                "\tforwardedfor:$http_x_forwarded_for"
                "\treq:$request"
                "\tstatus:$status"
                "\tmethod:$request_method"
                "\turi:$request_uri"
                "\tsize:$body_bytes_sent"
                "\treferer:$http_referer"
                "\tua:$http_user_agent"
                "\treqtime:$request_time"
                "\tcache:$upstream_http_x_cache"
                "\truntime:$upstream_http_x_runtime"
                "\tapptime:$upstream_response_time"
                "\tvhost:$host";

access_log /var/log/nginx/access.log ltsv;
```

### 使い方

- 通常の使い方
```
$ cat /var/log/nginx/access.log | alp ltsv
+-------+--------+-------------------------------------------------------------+-----+------+-----+-----+-----+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
| COUNT | METHOD |                             URI                             | 1XX | 2XX  | 3XX | 4XX | 5XX |  MIN  |  MAX  |   SUM   |  AVG  |  P1   |  P50  |  P99  | STDDEV | MIN(BODY) | MAX(BODY) |  SUM(BODY)   | AVG(BODY) |
+-------+--------+-------------------------------------------------------------+-----+------+-----+-----+-----+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
|     1 | GET    | /api/estate/28817                                           |   0 |    1 |   0 |   0 |   0 | 0.000 | 0.000 |   0.000 | 0.000 | 0.000 | 0.000 | 0.000 |  0.000 |   620.000 |   620.000 |      620.000 |   620.000 |
|     1 | GET    | /api/estate/14721                                           |   0 |    1 |   0 |   0 |   0 | 0.000 | 0.000 |   0.000 | 0.000 | 0.000 | 0.000 | 0.000 |  0.000 |   631.000 |   631.000 |      631.000 |   631.000 |
|     1 | POST   | /api/estate/req_doc/24565                                   |   0 |    1 |   0 |   0 |   0 | 0.000 | 0.000 |   0.000 | 0.000 | 0.000 | 0.000 | 0.000 |  0.000 |     0.000 |     0.000 |        0.000 |     0.000 |
|     1 | GET    | /config/getuser                                             |   0 |    0 |   0 |   1 |   0 | 0.000 | 0.000 |   0.000 | 0.000 | 0.000 | 0.000 | 0.000 |  0.000 |   154.000 |   154.000 |      154.000 |   154.000 |
（略）
```

- filter
条件にマッチするものだけを抜き出す
```
$ cat /var/log/nginx/access.log | alp ltsv --filters "Uri matches '^/api/estate'"
+-------+-----+------+-----+-----+-----+--------+------------------------------+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
| COUNT | 1XX | 2XX  | 3XX | 4XX | 5XX | METHOD |             URI              |  MIN  |  MAX  |   SUM   |  AVG  |  P90  |  P95  |  P99  | STDDEV | MIN(BODY) | MAX(BODY) |  SUM(BODY)   | AVG(BODY) |
+-------+-----+------+-----+-----+-----+--------+------------------------------+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/1414             | 0.004 | 0.004 | 0.004   | 0.004 | 0.004 | 0.004 | 0.004 | 0.000  | 650.000   | 650.000   | 650.000      | 650.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/9092             | 0.016 | 0.016 | 0.016   | 0.016 | 0.016 | 0.016 | 0.016 | 0.000  | 593.000   | 593.000   | 593.000      | 593.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/17463            | 0.020 | 0.020 | 0.020   | 0.020 | 0.020 | 0.020 | 0.020 | 0.000  | 628.000   | 628.000   | 628.000      | 628.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/29               | 0.012 | 0.012 | 0.012   | 0.012 | 0.012 | 0.012 | 0.012 | 0.000  | 557.000   | 557.000   | 557.000      | 557.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/24               | 0.016 | 0.016 | 0.016   | 0.016 | 0.016 | 0.016 | 0.016 | 0.000  | 635.000   | 635.000   | 635.000      | 635.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/70               | 0.020 | 0.020 | 0.020   | 0.020 | 0.020 | 0.020 | 0.020 | 0.000  | 621.000   | 621.000   | 621.000      | 621.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/99               | 0.084 | 0.084 | 0.084   | 0.084 | 0.084 | 0.084 | 0.084 | 0.000  | 621.000   | 621.000   | 621.000      | 621.000   |
```
- sort, count
条件にマッチするものだけを抜き出し、count昇順にソート
```
$ cat /var/log/nginx/access.log | alp ltsv --filters "Uri matches '^/api/estate'" --sort=count
+-------+-----+------+-----+-----+-----+--------+------------------------------+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
| COUNT | 1XX | 2XX  | 3XX | 4XX | 5XX | METHOD |             URI              |  MIN  |  MAX  |   SUM   |  AVG  |  P90  |  P95  |  P99  | STDDEV | MIN(BODY) | MAX(BODY) |  SUM(BODY)   | AVG(BODY) |
+-------+-----+------+-----+-----+-----+--------+------------------------------+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/1414             | 0.004 | 0.004 | 0.004   | 0.004 | 0.004 | 0.004 | 0.004 | 0.000  | 650.000   | 650.000   | 650.000      | 650.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/9092             | 0.016 | 0.016 | 0.016   | 0.016 | 0.016 | 0.016 | 0.016 | 0.000  | 593.000   | 593.000   | 593.000      | 593.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/17463            | 0.020 | 0.020 | 0.020   | 0.020 | 0.020 | 0.020 | 0.020 | 0.000  | 628.000   | 628.000   | 628.000      | 628.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/29               | 0.012 | 0.012 | 0.012   | 0.012 | 0.012 | 0.012 | 0.012 | 0.000  | 557.000   | 557.000   | 557.000      | 557.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/24               | 0.016 | 0.016 | 0.016   | 0.016 | 0.016 | 0.016 | 0.016 | 0.000  | 635.000   | 635.000   | 635.000      | 635.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/70               | 0.020 | 0.020 | 0.020   | 0.020 | 0.020 | 0.020 | 0.020 | 0.000  | 621.000   | 621.000   | 621.000      | 621.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/99               | 0.084 | 0.084 | 0.084   | 0.084 | 0.084 | 0.084 | 0.084 | 0.000  | 621.000   | 621.000   | 621.000      | 621.000   |
```

- sort, count, rev
条件にマッチするものだけを抜き出し、count降順にソート
```
$ cat /var/log/nginx/access.log | alp ltsv --filters "Uri matches '^/api/estate'" --sort=count -r
+-------+-----+------+-----+-----+-----+--------+------------------------------+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
| COUNT | 1XX | 2XX  | 3XX | 4XX | 5XX | METHOD |             URI              |  MIN  |  MAX  |   SUM   |  AVG  |  P90  |  P95  |  P99  | STDDEV | MIN(BODY) | MAX(BODY) |  SUM(BODY)   | AVG(BODY) |
+-------+-----+------+-----+-----+-----+--------+------------------------------+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
| 3819  | 0   | 3811 | 0   | 8   | 0   | GET    | /api/estate/search           | 0.028 | 0.476 | 350.532 | 0.092 | 0.152 | 0.180 | 0.236 | 0.045  | 0.000     | 32611.000 | 59225293.000 | 15508.063 |
| 1343  | 0   | 1343 | 0   | 0   | 0   | GET    | /api/estate/low_priced       | 0.016 | 0.304 | 65.637  | 0.049 | 0.080 | 0.088 | 0.132 | 0.024  | 13383.000 | 13427.000 | 17999481.000 | 13402.443 |
| 563   | 0   | 563  | 0   | 0   | 0   | GET    | /api/estate/search/condition | 0.004 | 0.016 | 0.628   | 0.001 | 0.004 | 0.004 | 0.008 | 0.002  | 2563.000  | 2563.000  | 1442969.000  | 2563.000  |
| 352   | 0   | 326  | 0   | 26  | 0   | POST   | /api/estate/nazotte          | 0.016 | 2.001 | 145.779 | 0.414 | 1.192 | 2.000 | 2.000 | 0.537  | 0.000     | 34281.000 | 5535224.000  | 15725.068 |
| 121   | 0   | 121  | 0   | 0   | 0   | GET    | /api/estate/20621            | 0.004 | 0.164 | 1.900   | 0.016 | 0.040 | 0.056 | 0.104 | 0.024  | 659.000   | 659.000   | 79739.000    | 659.000   |
| 120   | 0   | 120  | 0   | 0   | 0   | GET    | /api/estate/20819            | 0.000 | 0.088 | 1.800   | 0.015 | 0.036 | 0.048 | 0.084 | 0.017  | 621.000   | 621.000   | 74520.000    | 621.000   |
| 116   | 0   | 116  | 0   | 0   | 0   | GET    | /api/estate/15441            | 0.004 | 0.324 | 2.257   | 0.019 | 0.040 | 0.064 | 0.180 | 0.037  | 592.000   | 592.000   | 68672.000    | 592.000   |
```
- sort, count, rev (2)
条件にマッチするものだけを抜き出し、処理時間の平均降順にソート
```
$ cat /var/log/nginx/access.log | alp ltsv --filters "Uri matches '^/api/estate'" --sort=count
+-------+-----+------+-----+-----+-----+--------+------------------------------+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
| COUNT | 1XX | 2XX  | 3XX | 4XX | 5XX | METHOD |             URI              |  MIN  |  MAX  |   SUM   |  AVG  |  P90  |  P95  |  P99  | STDDEV | MIN(BODY) | MAX(BODY) |  SUM(BODY)   | AVG(BODY) |
+-------+-----+------+-----+-----+-----+--------+------------------------------+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/1414             | 0.004 | 0.004 | 0.004   | 0.004 | 0.004 | 0.004 | 0.004 | 0.000  | 650.000   | 650.000   | 650.000      | 650.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/9092             | 0.016 | 0.016 | 0.016   | 0.016 | 0.016 | 0.016 | 0.016 | 0.000  | 593.000   | 593.000   | 593.000      | 593.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/17463            | 0.020 | 0.020 | 0.020   | 0.020 | 0.020 | 0.020 | 0.020 | 0.000  | 628.000   | 628.000   | 628.000      | 628.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/29               | 0.012 | 0.012 | 0.012   | 0.012 | 0.012 | 0.012 | 0.012 | 0.000  | 557.000   | 557.000   | 557.000      | 557.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/24               | 0.016 | 0.016 | 0.016   | 0.016 | 0.016 | 0.016 | 0.016 | 0.000  | 635.000   | 635.000   | 635.000      | 635.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/70               | 0.020 | 0.020 | 0.020   | 0.020 | 0.020 | 0.020 | 0.020 | 0.000  | 621.000   | 621.000   | 621.000      | 621.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/99               | 0.084 | 0.084 | 0.084   | 0.084 | 0.084 | 0.084 | 0.084 | 0.000  | 621.000   | 621.000   | 621.000      | 621.000   |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/estate/93               | 0.116 | 0.116 | 0.116   | 0.116 | 0.116 | 0.116 | 0.116 | 0.000  | 679.000   | 679.000   | 679.000      | 679.000   |
```

- sort, count, rev (2)
条件にマッチするものだけを抜き出し、それらをまとめる
```
$ cat /var/log/nginx/access.log | alp ltsv --filters "Uri matches '^/api/estate'" -m "^/api/estate/.+"
+-------+-----+-------+-----+-----+-----+--------+-----------------+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
| COUNT | 1XX |  2XX  | 3XX | 4XX | 5XX | METHOD |       URI       |  MIN  |  MAX  |   SUM   |  AVG  |  P90  |  P95  |  P99  | STDDEV | MIN(BODY) | MAX(BODY) |  SUM(BODY)   | AVG(BODY) |
+-------+-----+-------+-----+-----+-----+--------+-----------------+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
| 5     | 0   | 5     | 0   | 0   | 0   | POST   | /api/estate     | 0.232 | 0.764 | 2.616   | 0.523 | 0.764 | 0.764 | 0.764 | 0.234  | 0.000     | 0.000     | 0.000        | 0.000     |
| 1552  | 0   | 1526  | 0   | 26  | 0   | POST   | ^/api/estate/.+ | 0.004 | 2.001 | 150.667 | 0.097 | 0.220 | 0.608 | 2.000 | 0.308  | 0.000     | 34281.000 | 5535224.000  | 3566.510  |
| 12537 | 0   | 12518 | 0   | 19  | 0   | GET    | ^/api/estate/.+ | 0.004 | 0.476 | 538.325 | 0.043 | 0.108 | 0.136 | 0.196 | 0.046  | 0.000     | 32611.000 | 82842688.000 | 6607.856  |
+-------+-----+-------+-----+-----+-----+--------+-----------------+-------+-------+---------+-------+-------+-------+-------+--------+-----------+-----------+--------------+-----------+
```

- その他の使い方：https://github.com/tkuchiki/alp/blob/main/README.ja.md 参照してね（日本語なので読みやすい）

### 備考・注意点・躓いた点
- alp のバージョン
  - 巷の解説サイトは v0.4.0 のものが多いので注意。最新は v1.0.10
  - オプションの使い方や引数が違うので注意
- nginxのアクセスログ（access.log）が生成されないとき
  - sudo systemctl restart nginx しましたか
  - sudo systemctl reload nginx しましたか
  - そのnginxに本当にアクセスが通っていますか？
    - 生のnginxとdockerで立ち上げたコンテナ内で走るnginxは別物です
    - `sudo docker-compose -f go.yaml exec nginx bash` でnginx内でbashを実行する
  - ファイルのアクセス権限は適切ですか？
    - https://www.bit-hive.com/articles/20220414
    - ディレクトリの所有者、パーミッション、ログファイルの所有者パーミッションをチェック
- コンテナ内ログファイルに対してalpしたい
  - 共有ボリュームを設定してデータを外に出すと吉
  - あるいはnginx自体で配信してしまうとか。

### 参考文献
- https://nasaemon.hateblo.jp/entry/isucon_joban
  - 0.4.0のインストール記事なので注意
- https://www.bit-hive.com/articles/20220414
- https://github.com/tkuchiki/alp/blob/main/README.ja.md
  - 公式